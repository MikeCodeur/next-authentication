# Librairie Next-Auth

### üí° Utiliser NextAuth (AuthJS)

## üìù Tes notes

D√©taille ce que tu as appris ici,¬†sur¬†une¬†page¬†[Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans les modules pr√©c√©dents, nous avons cr√©√© notre propre syst√®me d'authentification par `credentials` ainsi que la gestion des sessions. Cependant, il est parfois n√©cessaire d'utiliser un ou plusieurs syst√®mes d'authentifications tiers, qu'ils soient priv√©s ou publiques.

Par exemple, nous pourrions avoir besoin de permettre la connexion via `Google`, `Facebook`, `Github` ou n'importe quel autre fournisseur. Pour cela, il existe une librairie appel√©e `Next Auth`, r√©cemment renomm√©e [`AuthJS`](https://authjs.dev/getting-started/installation?framework=next.js). Son objectif est d'abstraire la gestion des sessions et de simplifier l'int√©gration avec d'autres syst√®mes d'authentification.

## Installation :

Les 3 fichiers principaux :

### `auth.ts`

Le fichier principal contenant toute la configuration, providers etc‚Ä¶

```tsx
//./auth.ts
import NextAuth from 'next-auth'

export const {handlers, signIn, signOut, auth} = NextAuth({
  providers: [],
})
```

### `route.ts`

La route de callback

```tsx
//./app/api/auth/[...nextauth]/route.ts
import {handlers} from '@/auth' // Referring to the auth.ts we just created
export const {GET, POST} = handlers
```

### `middleware.ts`

Le middleware

```tsx
//./middleware.ts
export {auth as middleware} from '@/auth'
```

üìë Le lien vers la doc [https://fr.reactjs.org/docs/getting-started.html](https://fr.reactjs.org/docs/getting-started.html)

## Providers :

Il existe de nombreux providers comme `Google`, `Facebook`, etc‚Ä¶

Ils sont regroup√©s par types :

- Oauth
- Magic Link
- Credential
- WebAuthn

Pour ajouter un provider( exemple Google) :

```tsx
import NextAuth from 'next-auth'
import Google from 'next-auth/providers/google'

export const {handlers, signIn, signOut, auth} = NextAuth({
  providers: [Google],
})
```

Et ensuite :

```tsx
import {signIn} from '@/auth'

export function SignIn() {
  return (
    <form
      action={async () => {
        'use server'
        await signIn('google')
      }}
    >
      <button type="submit">Signin with Google</button>
    </form>
  )
}
```

Doc : https://authjs.dev/getting-started/authentication/oauth

## Exercice

Dans cet exercice, tu vas devoir d√©commissionner l‚Äôancien mode de fonctionnement et utiliser `Next-Auth`

<aside>
üí° 
Les middlewares de `Next.js` et `NextAuth` fonctionnent avec le runtime `Edge`, optimis√©s pour des r√©ponses rapides. Ils n'incluent pas l**'int√©gralit√© des API Node.js**, notamment `fs` (syst√®me de fichiers). Cela permet une ex√©cution plus l√©g√®re et s√©curis√©e en environnement `Edge`.

</aside>

Runtime check

```tsx
console.log('process.env.NEXT_RUNTIME AUTH', process.env.NEXT_RUNTIME)
```

Pour les besoins de l‚Äôexercice, nous avons chang√© `lowDb` par `Unstorage` qui permet d‚Äôavoir une DB en m√©moire (ce qui nous permet d‚Äôappeler des fonctions comme `getUserByEmail` depuis le `middleware/nextAuth`).

En production et pour des projets de plus grande ampleur, il faut utiliser une librairie de gestion de BDD compatible :

- [https://authjs.dev/getting-started/database](https://authjs.dev/getting-started/database)
- `bcrypt` a √©t√© remplac√© par `bcryptjs` mais le fonctionnement reste le m√™me.

Pour simplifier l‚Äôexercice, voil√† l‚Äôensemble du d√©commissionnement.

### D√©commissionnement :

- `@/db/sgbd`
  - Remplac√© par `@/db/sgbd-unstorage`
- `@/app/exercises/auth/lib/auth`
  - `Next-Auth`
- `@/app/exercises/auth/session`
  - `Next-Auth`

### Adaptation

- `bcrypt`
  - Remplac√© par `bcryptjs`
- dal (`verifySession`)
  - `Next-Auth`
- action (`import {auth} from '@/app/exercises/auth/lib/auth`)
  - `Next-Auth`

Tu retrouveras √©galement des formulaires d√©j√† connect√©s :

```tsx
<div className="mx-auto max-w-2xl p-6  text-lg ">
  {/* <LoginForm></LoginForm> */}
  <h1 className="mb-4 text-center text-3xl font-bold">Google</h1>
  <SignInGoogle></SignInGoogle>
  <h1 className="mb-4 text-center text-3xl font-bold">Credentials</h1>
  <SignInCredential />
  <h1 className="mb-4 text-center text-3xl font-bold">Resend</h1>
  <SignInResend />
</div>
```

Pour [Google](https://developers.google.com/identity/protocols/oauth2?hl=fr) autre provider, cela requiert des cl√©s `API` √† cr√©er sur `Google Cloud` ou sur [Github](https://authjs.dev/guides/configuring-github)

Nous allons ici nous concentrer sur le `credentials` `<SignInCredential />`

Dans la documentation, nous avons un appel √† `singIn` :

```tsx
import {signIn} from '@/auth'

export function SignIn() {
  return (
    <form
      action={async (formData) => {
        'use server'
        await signIn('credentials', formData)
      }}
    >
      <label>
        Email
        <input name="email" type="email" />
      </label>
      <label>
        Password
        <input name="password" type="password" />
      </label>
      <button>Sign In</button>
    </form>
  )
}
```

Dans notre cas, nous appellerons d‚Äôabord le `server action` avec le hook `useActionstate` ce qui nous permettra de g√©rer les erreurs et le `formStatus`

```tsx
const [actionState, authenticateAction] = useActionState(authenticate, {})
```

- **üê∂ Dans un premier temps, il va d√©commissionner l‚Äôappel √† notre lib `auth.ts` perso dans la fonction `authenticate` et utilise `signIn` de `nextAuth` √† la place**
- **üê∂** D√©place la logique de validation `user/mdp` dans le fichier `auth.ts` de `nextAuth`

Fichiers

- `/auth.ts`
- `/app/exercices/auth/action.ts`

## Bonus

### 1. üöÄ Register

Adapte la fonction `register` de l‚Äôaction. Le but √©tant de s‚Äôinscrire et de g√©n√©rer une session pour √™tre directement connect√©.

Fichiers

- `/app/exercices/auth/action.ts`

### 2. üöÄ Protected route (Role Based)

Pour prot√©ger les routes :

```tsx
import {auth} from '@/auth'

export default async function Page() {
  const session = await auth()
  if (!session) return <div>Not authenticated</div>

  return (
    <div>
      <pre>{JSON.stringify(session, null, 2)}</pre>
    </div>
  )
}
```

https://authjs.dev/getting-started/session-management/protecting

Mais il est possible de le faire dans `auth.ts` gr√¢ce √† un callback `authorized`

```tsx
export const {handlers, signIn, signOut, auth} = NextAuth({
  callbacks: {
    authorized: async ({auth, request: {nextUrl}}) => {
    if (isProtectedRoute && !hasSession) {
        return Response.redirect(new URL('/exercises/login', nextUrl))
     }
  return true
    },
  },
```

Dans cet exercice, tu vas devoir impl√©menter la m√™me r√®gle de protection des routes que pr√©c√©demment : Rappel :

```tsx
// 1. Specify protected and public routes
const protectedRoutes = new Set([
  '/exercises/dashboard',
  '/exercises/bank-account',
])
const publicRoutes = new Set(['/'])

const adminRoutes = new Set(['/admin'])

const redactorRoutes = new Set(['/redaction'])

export async function middleware(request: NextRequest) {
  const path = request.nextUrl.pathname
  const isProtectedRoute = protectedRoutes.has(path)
  const isPublicRoute = publicRoutes.has(path)
  const isAdminRoute = adminRoutes.has(path)
  const isRedactorRoute = redactorRoutes.has(path)

  const cookie = cookies().get('session')?.value
  const session = await decrypt(cookie)

  const role = session?.role
  console.log('middleware role', role)

  const hasSession = session?.userId || session?.sessionId

  if (isProtectedRoute && !hasSession) {
    return NextResponse.redirect(new URL('/exercises/login', request.nextUrl))
  }
  //admin route
  if (
    isAdminRoute &&
    !role?.includes(RoleEnum.ADMIN) &&
    !role?.includes(RoleEnum.SUPER_ADMIN)
  ) {
    return NextResponse.redirect(new URL('/restricted/', request.nextUrl))
  }
  // Redactor route
  if (
    isRedactorRoute &&
    !role?.includes(RoleEnum.ADMIN) &&
    !role?.includes(RoleEnum.SUPER_ADMIN) &&
    !role?.includes(RoleEnum.REDACTOR) &&
    !role?.includes(RoleEnum.MODERATOR)
  ) {
    return NextResponse.redirect(new URL('/restricted/', request.nextUrl))
  }
  if (isPublicRoute && hasSession) {
    return NextResponse.redirect(new URL('/exercises/auth', request.nextUrl))
  }
  NextResponse.next()
}
```

- **üê∂ R√©cup√®re le R√îLE du user avec `getUserByEmail` et impl√©mente les m√™mes r√®gles.**

Fichiers

- `auth.ts`

## Aller plus loin

üìë Le lien vers la doc [https://authjs.dev/getting-started/installation?framework=next.js](https://authjs.dev/getting-started/installation?framework=next.js)

## Ils vont t‚Äôaider

- **üê∂ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ü§ñ Ash le Robot** : _Ash le Robot te donnera du code utile._
- **üöÄ Julia La roquette** : _Julia te donnera des d√©fis suppl√©mentaires._
- **‚õèÔ∏è Hulk le Marteau** : _Quand du code √† supprimer est pr√©sent_
- **üë®‚Äç‚úàÔ∏è Hugo le chef de projet** : _Va t'aider sur les sp√©cifications du projet_

## üêú Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=05.Next%20Auth&entry.533578441=13%20Next%20-%20Auth).
