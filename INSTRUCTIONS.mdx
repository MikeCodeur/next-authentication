# Next Middleware

### 💡 Comprendre Next Middleware

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Les middlewares dans `Next.js` **permettent d'exécuter du code avant qu'une requête ne soit complétée**. Grâce aux `middlewares`, vous pouvez modifier la réponse en réécrivant, redirigeant, modifiant les en-têtes de requête ou de réponse, ou en répondant directement en fonction de la requête entrante.

Les middlewares s'exécutent avant que le contenu mis en cache et les routes ne soient appariés.

### Cas d'Utilisation des Middlewares

Intégrer des middlewares dans votre application peut entraîner des améliorations significatives en termes de performances, de sécurité et d'expérience utilisateur. Voici quelques scénarios courants où les middlewares sont particulièrement efficaces :

- **Authentification et Autorisation** : Vérifiez l'identité de l'utilisateur et contrôlez les cookies de session avant de lui accorder l'accès à des pages ou des routes `API` spécifiques.
- **Redirections Serveur** : Redirigez les utilisateurs au niveau du serveur en fonction de certaines conditions (par exemple, la langue, le rôle de l'utilisateur).
- **Réécriture de Chemins** : Prenez en charge les tests `A/B`, les déploiements de fonctionnalités ou les chemins d'accès hérités en réécrivant dynamiquement les chemins vers des routes `API` ou des pages en fonction des propriétés de la requête.
- **Détection de Bots** : Protégez vos ressources en détectant et en bloquant le trafic des bots.
- **Journalisation et Analyse** : Capturez et analysez les données de la requête pour obtenir des informations avant le traitement par la page ou l'`API`.
- **Gestion de Fonctionnalités** : Activez ou désactivez des fonctionnalités de manière dynamique pour des déploiements de fonctionnalités ou des tests en douceur.

### Scénarios à Éviter avec les Middlewares

Il est également important de reconnaître les situations où les middlewares ne sont pas la solution optimale :

- **Récupération et Manipulation Complexe de Données** : Les middlewares ne sont pas conçus pour la récupération directe ou la manipulation des données, cela doit être fait au sein des gestionnaires de routes ou des utilitaires côté serveur.
- **Tâches Computationnelles Lourdes** : Les middlewares doivent être légers et répondre rapidement. Les tâches computationnelles lourdes ou les processus de longue durée doivent être effectués dans des gestionnaires de routes dédiés.
- **Gestion Extensive de Sessions** : Bien que les middlewares puissent gérer des tâches de session basiques, la gestion extensive de sessions doit être confiée à des services d'authentification dédiés ou aux gestionnaires de routes.
- **Opérations Directes sur la Base de Données** : Les opérations directes sur la base de données dans les middlewares ne sont pas recommandées. Les interactions avec la base de données doivent être effectuées dans les gestionnaires de routes ou les utilitaires côté serveur.

Un exemple simple est par exemple de dire

- Si une requête est faite sur `‘/’` on redirige vers `‘/exercises’`

```tsx
//src/middleware.ts
import {NextResponse, type NextRequest} from 'next/server'

export async function middleware(request: NextRequest) {
  const path = request.nextUrl.pathname
  if (path === '/') {
    return NextResponse.redirect(new URL('/exercises', request.url))
  }
  return NextResponse.next()
}
```

📑 Le lien vers la doc [https://nextjs.org/docs/app/building-your-application/routing/middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware)

## Exercice

Dans les exercices précédents, nous avons utilisé un `HOC withAuth` pour protéger nos routes. Nous avons ici une autre méthode, le `middleware next`. Pour les besoins de l’exercice, nous avons supprimé `withAuth` des routes protégées (`dashboard` / `bank-account` etc…).

- Elles ne sont donc plus protégées.

**🐶 Dans cet exercice, tu vas devoir implémenter un middleware pour protéger les routes privées.**

Le principe va être de :

- Analyser la route demandée (publique ou privée).
- Décrypter le cookie.
- Vérifier la présence ou non de `sessionId` ou `userId`
- Rediriger en conséquence.
  - Route privée
    - Pas de session → redirection `/login`
    - Si session → on laisse passer
  - Route publique
    - Pas de session → on laisse passer
    - Si session → redirection `/auth`

Fichiers

- `src/middleware.ts`

## Aller plus loin

📑 Le lien vers la doc [https://nextjs.org/docs/app/building-your-application/routing/redirecting#nextresponseredirect-in-middleware](https://nextjs.org/docs/app/building-your-application/routing/redirecting#nextresponseredirect-in-middleware)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=05.Next%20Auth&entry.533578441=10%20MiddleWare).
