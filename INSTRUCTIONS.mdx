# Session Management - Cookies

### 💡 Comprendre les sessions `stateless`

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

La gestion de session implique le suivi et la gestion des interactions d'un utilisateur avec l'application au fil du temps, en veillant à ce que son état authentifié soit préservé dans les différentes parties de l'application.

Cela évite la nécessité de se reconnecter à plusieurs reprises, améliorant à la fois la sécurité et la commodité pour l'utilisateur.

Il existe deux méthodes principales pour la gestion des sessions :

- les **sessions basées sur les cookies** (`stateless session`).
- Et les sessions stockées en **base de données**. (`database session`).

Dans cette section, nous verrons les sessions simples basées sur les cookies.

### Principe :

- Lorsque l’utilisateur est connecté → Création d’un Cookie avec `userId` par exemple.
- Ce cookie est présent dans le header des requêtes HTTP.
- La session est décodée / vérifiée pour extraire le `userId` côté le serveur.
- Il est ensuite possible d’accéder aux données utilisateurs (`userId`) et de gérer les accès par exemple.

### Cookie server avec `Next`

```tsx
'use server'

import {cookies} from 'next/headers'

export async function handleLogin(sessionData) {
  const encryptedSessionData = encrypt(sessionData) // Encrypt your session data
  cookies().set('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // One week
    path: '/',
  })
  // Redirect or handle the response after setting the cookie
}
```

## Exercice

Dans cet exercice, tu vas devoir créer le mécanisme de session géré par des cookies.

Pour simplifier l’exercice, nous n’allons pas encore encrypter le cookie, mais seulement manipuler du `JSON`

```tsx
//lib/crypt.ts
export async function encrypt(payload: SessionPayload) {
  return JSON.stringify(payload)
}

export async function decrypt(
  session: string | undefined = ''
): Promise<SessionPayload | undefined> {
  return JSON.parse(session)
}
```

🐶 Dans un premier temps, implémente les 3 fonctions suivantes :

- `createSession`
- `verifySession`
- `deleteSession`

**🐶** Dans **`auth.ts`** crée une session après la création de compte ou la connexion et supprime le cookie sur le `logout`

Fichiers

- `exercise/auth/lib/session-stateless.ts`
- `exercise/auth/lib/auth.ts`

## Bonus

### 1. 🚀 Gestion de page avec information session utilisateur

Maintenant que nous savons créer des cookies de sessions, nous pouvons les utiliser dans nos pages pour récupérer les informations utilisateur.

- Dans cet exercice, **👨‍✈️ Hugo, le chef de projet,** te demande de modifier la route [/exercices/auth](http://localhost:3000/exercises/auth). Actuellement cette page affiche : **`You are not connected`.**
- Utilise `verifySession()` et `getUserById` pour afficher : `Hello {user.email}` si un utilisateur est connecté.

Fichiers

- `exercise/auth/page.tsx`

## Aller plus loin

📑 Le lien vers la doc [https://nextjs.org/docs/app/building-your-application/authentication#authentication](https://nextjs.org/docs/app/building-your-application/authentication#authentication)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=05.Next%20Auth&entry.533578441=04%20Session%20-%20Management%20-%20Cookies).
